local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local VirtualInputManager = game:GetService("VirtualInputManager")

local LocalPlayer = Players.LocalPlayer
local FishingSystem = ReplicatedStorage:WaitForChild("FishingSystem", 10)

if not FishingSystem then
    for _, obj in pairs(ReplicatedStorage:GetDescendants()) do
        if obj.Name:lower():find("fish") and obj:IsA("ModuleScript") then
            FishingSystem = obj.Parent
            break
        end
    end
end

local Config = {
    AutoFish = true,
    InstantCatch = true,
    SilentCatch = true,
    MinRarity = "Common",
    MaxRarity = "Unknown",
    MinWeight = 1,
    MaxWeight = 999,
    WeightPrecision = 1,
    AutoSell = true,
    SellBelowRarity = "Rare",
    FishGiver = {
        Enabled = false,
        TargetPlayer = "",
        FishName = "El Maja",
        Rarity = "Unknown",
        Weight = 999
    },
    RandomWeight = {
        Enabled = true,
        Mode = "CustomRange",
        MinRange = 1,
        MaxRange = 999,
        Bias = 0.7,
        Fluctuation = 0.3
    },
    WebhookNotify = false,
    AntiAFK = true,
    BypassCooldown = false
}

local RarityOrder = {
    Common = 1,
    Uncommon = 2,
    Rare = 3,
    Epic = 4,
    Legendary = 5,
    Unknown = 6
}

local RarityColors = {
    Common = Color3.fromRGB(200, 200, 200),
    Uncommon = Color3.fromRGB(30, 255, 30),
    Rare = Color3.fromRGB(30, 100, 255),
    Epic = Color3.fromRGB(160, 30, 255),
    Legendary = Color3.fromRGB(255, 128, 0),
    Unknown = Color3.fromRGB(190, 0, 3)
}

local RodList = {
    "Basic Rod",
    "Angelic Rod",
    "Gold Rod",
    "Lucky Rod",
    "Lightning",
    "Polarized",
    "Fluorescent Rod",
    "GhostRod",
    "Frozen Rod",
    "LightingPunk Rod",
    "Aqua Prism",
    "Flery",
    "Loving",
    "ZombieRod",
    "Forsaken",
    "Crystalized",
    "Earthly",
    "Manifest",
    "Megalofriend",
    "Purple Saber",
    "Pirate Octopus",
    "Katanaa",
    "Umbrella",
    "Developer Rod",
    "Admin Rod",
    "Owner Rod",
    "Vip Rod",
    "Naga Rod"
}

local originalModule
local moduleHookActive = false

local function HookGameFunctions()
    if moduleHookActive then return end
    
    for _, module in pairs(getloadedmodules() or {}) do
        if module.Name:lower():find("fish") or module.Name:find("Fishing") then
            local success, moduleData = pcall(require, module)
            if success and type(moduleData) == "table" then
                originalModule = moduleData
                
                -- Override GetRarityWithPity
                if moduleData.GetRarityWithPity then
                    local originalGetRarity = moduleData.GetRarityWithPity
                    moduleData.GetRarityWithPity = function(pityTable, rodName, luckMultiplier)
                        if Config.InstantCatch then
                            local minOrder = RarityOrder[Config.MinRarity] or 1
                            local maxOrder = RarityOrder[Config.MaxRarity] or 6
                            
                            local targetOrder = math.random(minOrder, maxOrder)
                            for rarity, order in pairs(RarityOrder) do
                                if order == targetOrder then
                                    return rarity
                                end
                            end
                            return Config.MaxRarity
                        end
                        return originalGetRarity(pityTable, rodName, luckMultiplier)
                    end
                end
                
                -- Override PickFishFromRarity
                if moduleData.PickFishFromRarity then
                    local originalPickFish = moduleData.PickFishFromRarity
                    moduleData.PickFishFromRarity = function(rarity)
                        if Config.InstantCatch then
                            local fishTable = moduleData.FishTable or {}
                            local eligibleFish = {}
                            
                            for _, fish in pairs(fishTable) do
                                if fish.rarity == rarity then
                                    table.insert(eligibleFish, fish)
                                end
                            end
                            
                            if #eligibleFish > 0 then
                                -- Pilih ikan berdasarkan probability
                                local totalProbability = 0
                                for _, fish in pairs(eligibleFish) do
                                    totalProbability = totalProbability + (fish.probability or 30)
                                end
                                
                                local random = math.random() * totalProbability
                                local cumulative = 0
                                
                                for _, fish in pairs(eligibleFish) do
                                    cumulative = cumulative + (fish.probability or 30)
                                    if random <= cumulative then
                                        return fish
                                    end
                                end
                                
                                return eligibleFish[1]
                            end
                        end
                        return originalPickFish(rarity)
                    end
                end
                
                -- Override GenerateFishWeight
                if moduleData.GenerateFishWeight then
                    local originalGenWeight = moduleData.GenerateFishWeight
                    moduleData.GenerateFishWeight = function(fishData, rodLuck, maxWeight)
                        if Config.InstantCatch or Config.RandomWeight.Enabled then
                            local weight
                            
                            if Config.RandomWeight.Enabled then
                                local mode = Config.RandomWeight.Mode
                                
                                if mode == "CustomRange" then
                                    weight = math.random(Config.RandomWeight.MinRange * 10, Config.RandomWeight.MaxRange * 10) / 10
                                elseif mode == "Extreme" then
                                    local scale = RarityOrder[fishData.rarity] or 1
                                    weight = math.random(50 * scale, 500 * scale)
                                elseif mode == "Chaos" then
                                    weight = math.random(1, 999)
                                else
                                    local minW = math.max(Config.MinWeight, fishData.minKg or 1)
                                    local maxW = math.min(Config.MaxWeight, fishData.maxKg or 999, maxWeight or 999)
                                    weight = minW + math.random() * (maxW - minW)
                                end
                                
                                -- Apply bias
                                if Config.RandomWeight.Bias > 0.5 then
                                    weight = weight * (1 + (Config.RandomWeight.Bias - 0.5))
                                end
                                
                                -- Apply fluctuation
                                if Config.RandomWeight.Fluctuation > 0 then
                                    local fluctuation = (math.random() * 2 - 1) * Config.RandomWeight.Fluctuation
                                    weight = weight * (1 + fluctuation)
                                end
                            else
                                local minWeight = math.max(Config.MinWeight, fishData.minKg or 1)
                                local maxWeightAllowed = math.min(Config.MaxWeight, fishData.maxKg or 999, maxWeight or 999)
                                weight = minWeight + math.random() * (maxWeightAllowed - minWeight)
                            end
                            
                            -- Apply precision
                            local precision = Config.WeightPrecision or 1
                            local multiplier = 10 ^ precision
                            weight = math.floor(weight * multiplier + 0.5) / multiplier
                            
                            -- Clamp to min/max
                            weight = math.max(Config.MinWeight, math.min(Config.MaxWeight, weight))
                            
                            return weight
                        end
                        return originalGenWeight(fishData, rodLuck, maxWeight)
                    end
                end
                
                -- Override RollFish
                if moduleData.RollFish then
                    local originalRollFish = moduleData.RollFish
                    moduleData.RollFish = function(pityTable, rodName, luckMultiplier)
                        if Config.SilentCatch then
                            local rarity
                            
                            -- Pilih rarity sesuai config
                            local minOrder = RarityOrder[Config.MinRarity] or 1
                            local maxOrder = RarityOrder[Config.MaxRarity] or 6
                            local targetOrder = math.random(minOrder, maxOrder)
                            
                            for r, order in pairs(RarityOrder) do
                                if order == targetOrder then
                                    rarity = r
                                    break
                                end
                            end
                            rarity = rarity or Config.MaxRarity
                            
                            -- Dapatkan ikan berdasarkan rarity
                            local fish = moduleData.PickFishFromRarity(rarity)
                            if not fish then
                                return originalRollFish(pityTable, rodName, luckMultiplier)
                            end
                            
                            -- Generate berat
                            local weight = moduleData.GenerateFishWeight(fish, luckMultiplier or 1, 999)
                            
                            -- Hitung nilai
                            local value = math.floor(weight * 1.2 * (RarityOrder[rarity] or 1) * 10 + 0.5)
                            
                            return {
                                name = fish.name,
                                rarity = fish.rarity,
                                weight = weight,
                                value = value
                            }
                        end
                        return originalRollFish(pityTable, rodName, luckMultiplier)
                    end
                end
                
                moduleHookActive = true
                warn("[Fishing Exploit] Module successfully hooked!")
                break
            end
        end
    end
end

local function SilentCatchFish()
    if not Config.SilentCatch then return false end
    
    local catchRemote = FishingSystem:FindFirstChild("CatchFish") or 
                       FishingSystem:FindFirstChild("ReelIn") or
                       FishingSystem:FindFirstChild("CompleteFishing")
    
    if catchRemote then
        -- Pilih rarity
        local minOrder = RarityOrder[Config.MinRarity] or 1
        local maxOrder = RarityOrder[Config.MaxRarity] or 6
        local targetOrder = math.random(minOrder, maxOrder)
        local rarity = Config.MaxRarity
        
        for r, order in pairs(RarityOrder) do
            if order == targetOrder then
                rarity = r
                break
            end
        end
        
        -- Generate berat
        local weight
        if Config.RandomWeight.Enabled then
            local mode = Config.RandomWeight.Mode
            if mode == "CustomRange" then
                weight = math.random(Config.RandomWeight.MinRange * 10, Config.RandomWeight.MaxRange * 10) / 10
            else
                weight = math.random(Config.MinWeight * 10, Config.MaxWeight * 10) / 10
            end
        else
            weight = math.random(Config.MinWeight * 10, Config.MaxWeight * 10) / 10
        end
        
        -- Apply precision
        local precision = Config.WeightPrecision or 1
        local multiplier = 10 ^ precision
        weight = math.floor(weight * multiplier + 0.5) / multiplier
        
        -- Pilih ikan rare dari module baru
        local rareFish = "El Maja"
        if originalModule and originalModule.FishTable then
            for _, fish in pairs(originalModule.FishTable) do
                if fish.rarity == "Unknown" then
                    rareFish = fish.name
                    break
                end
            end
        end
        
        local fakeFishData = {
            Name = rareFish,
            Rarity = rarity,
            Weight = weight,
            Value = math.floor(weight * 1.2 * 100 * (RarityOrder[rarity] or 1))
        }
        
        local success = pcall(function()
            if catchRemote:IsA("RemoteEvent") then
                catchRemote:FireServer(fakeFishData)
            elseif catchRemote:IsA("RemoteFunction") then
                catchRemote:InvokeServer(fakeFishData)
            end
        end)
        
        return success
    end
    return false
end

local AutoFishThread
local CatchCount = 0

local function AdvancedAutoFishing()
    if AutoFishThread then return end
    
    AutoFishThread = task.spawn(function()
        while Config.AutoFish do
            HookGameFunctions()
            
            local castRemote = FishingSystem:FindFirstChild("CastLine") or 
                              FishingSystem:FindFirstChild("StartFishing")
            
            if castRemote then
                -- Cast line
                pcall(function()
                    if castRemote:IsA("RemoteEvent") then
                        castRemote:FireServer()
                    elseif castRemote:IsA("RemoteFunction") then
                        castRemote:InvokeServer()
                    end
                end)
                
                -- Tunggu sebentar sebelum catch
                local waitTime = Config.BypassCooldown and 0.1 or math.random(0.5, 2.0)
                task.wait(waitTime)
                
                -- Catch fish
                if Config.SilentCatch then
                    SilentCatchFish()
                else
                    local catchRemote = FishingSystem:FindFirstChild("CatchFish")
                    if catchRemote then
                        pcall(function()
                            catchRemote:FireServer()
                        end)
                    end
                end
                
                CatchCount = CatchCount + 1
                
                -- Auto sell
                if Config.AutoSell and CatchCount % 5 == 0 then
                    task.spawn(function()
                        local sellRemote = FishingSystem:FindFirstChild("SellFish")
                        if sellRemote then
                            for rarity, order in pairs(RarityOrder) do
                                local sellOrder = RarityOrder[Config.SellBelowRarity] or 3
                                if order < sellOrder then
                                    pcall(function()
                                        sellRemote:FireServer(rarity)
                                    end)
                                    task.wait(0.1)
                                end
                            end
                        end
                    end)
                end
            end
            
            -- Delay antara fishing
            local delay = math.random(100, 300) / 100
            task.wait(delay)
        end
    end)
end

-- Load UI Library
local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/xHeptc/Kavo-UI-Library/main/source.lua"))()
local Window = Library.CreateLib("Fishing Exploit v8.0", "DarkTheme")

-- Main Tab
local MainTab = Window:NewTab("Main")
local FishingSection = MainTab:NewSection("Fishing Features")

FishingSection:NewToggle("Auto Fish", "Automatically fishes", function(state)
    Config.AutoFish = state
    if state then
        AdvancedAutoFishing()
    else
        if AutoFishThread then
            task.cancel(AutoFishThread)
            AutoFishThread = nil
        end
    end
end)

FishingSection:NewToggle("Instant Catch", "Skip minigame", function(state)
    Config.InstantCatch = state
    HookGameFunctions()
end)

FishingSection:NewToggle("Silent Catch", "No animation", function(state)
    Config.SilentCatch = state
end)

-- Rarity Tab
local RarityTab = Window:NewTab("Rarity Control")
local MinRaritySection = RarityTab:NewSection("Minimum Rarity")

local MinRarityDropdown = MinRaritySection:NewDropdown("Min Rarity", "Lowest rarity", 
    {"Common", "Uncommon", "Rare", "Epic", "Legendary", "Unknown"}, 
    function(selected)
        Config.MinRarity = selected
    end)
MinRarityDropdown:SetOption("Common")

local MaxRaritySection = RarityTab:NewSection("Maximum Rarity")
local MaxRarityDropdown = MaxRaritySection:NewDropdown("Max Rarity", "Highest rarity", 
    {"Common", "Uncommon", "Rare", "Epic", "Legendary", "Unknown"}, 
    function(selected)
        Config.MaxRarity = selected
    end)
MaxRarityDropdown:SetOption("Unknown")

-- Weight Tab
local WeightTab = Window:NewTab("Weight Control")
local WeightRangeSection = WeightTab:NewSection("Weight Range")

local MinWeightSlider = WeightRangeSection:NewSlider("Min Weight", "Minimum weight", 1000, 0.1, function(value)
    Config.MinWeight = value
end)
MinWeightSlider:SetValue(1)

local MaxWeightSlider = WeightRangeSection:NewSlider("Max Weight", "Maximum weight", 1000, 0.1, function(value)
    Config.MaxWeight = value
end)
MaxWeightSlider:SetValue(999)

local RandomWeightSection = WeightTab:NewSection("Random Weight")

RandomWeightSection:NewToggle("Enable Random Weight", "Randomize weights", function(state)
    Config.RandomWeight.Enabled = state
end)

local WeightModeDropdown = RandomWeightSection:NewDropdown("Weight Mode", "Weight generation mode", 
    {"Original", "CustomRange", "Extreme", "Chaos"}, 
    function(selected)
        Config.RandomWeight.Mode = selected
    end)
WeightModeDropdown:SetOption("CustomRange")

local CustomMinSlider = RandomWeightSection:NewSlider("Custom Min", "Minimum for custom mode", 
    1000, 1, 100, function(value)
    Config.RandomWeight.MinRange = value
end)
CustomMinSlider:SetValue(1)

local CustomMaxSlider = RandomWeightSection:NewSlider("Custom Max", "Maximum for custom mode", 
    1000, 100, 999, function(value)
    Config.RandomWeight.MaxRange = value
end)
CustomMaxSlider:SetValue(999)

local BiasSlider = RandomWeightSection:NewSlider("Weight Bias", "Bias to high weights", 
    100, 0, 100, function(value)
    Config.RandomWeight.Bias = value / 100
end)
BiasSlider:SetValue(70)

local FluctuationSlider = RandomWeightSection:NewSlider("Fluctuation", "Random variation", 
    100, 0, 100, function(value)
    Config.RandomWeight.Fluctuation = value / 100
end)
FluctuationSlider:SetValue(30)

local PrecisionSection = WeightTab:NewSection("Precision")
local PrecisionSlider = PrecisionSection:NewSlider("Decimal Places", "Weight precision", 3, 0, function(value)
    Config.WeightPrecision = value
end)
PrecisionSlider:SetValue(1)

-- Utilities Tab
local UtilTab = Window:NewTab("Utilities")
local UtilitySection = UtilTab:NewSection("Tools")

UtilitySection:NewToggle("Bypass Cooldown", "Remove cooldown", function(state)
    Config.BypassCooldown = state
end)

UtilitySection:NewToggle("Anti-AFK", "Prevent AFK", function(state)
    Config.AntiAFK = state
end)

UtilitySection:NewButton("Hook Functions", "Hook fishing module", function()
    HookGameFunctions()
    Library:Notify(moduleHookActive and "✅ Successfully hooked!" or "❌ Failed to hook", 3)
end)

UtilitySection:NewButton("Test Silent Catch", "Test catch function", function()
    local success = SilentCatchFish()
    Library:Notify(success and "✅ Silent catch successful!" or "❌ Silent catch failed", 3)
end)

-- Stats Tab
local StatsTab = Window:NewTab("Stats")
local LiveStats = StatsTab:NewSection("Statistics")

local TotalCatches = LiveStats:NewLabel("Total Catches: 0")
local CurrentRarity = LiveStats:NewLabel("Rarity Range: Common - Unknown")
local CurrentWeight = LiveStats:NewLabel("Weight Range: 1kg - 999kg")
local ModuleStatus = LiveStats:NewLabel("Module: Not Hooked")

task.spawn(function()
    while task.wait(1) do
        TotalCatches:UpdateLabel("Total Catches: " .. CatchCount)
        CurrentRarity:UpdateLabel("Rarity Range: " .. Config.MinRarity .. " - " .. Config.MaxRarity)
        CurrentWeight:UpdateLabel("Weight Range: " .. Config.MinWeight .. "kg - " .. Config.MaxWeight .. "kg")
        ModuleStatus:UpdateLabel("Module: " .. (moduleHookActive and "✅ Hooked" or "❌ Not Hooked"))
    end
end)

-- Anti-AFK
if Config.AntiAFK then
    task.spawn(function()
        while task.wait(60) do
            if Config.AntiAFK then
                pcall(function()
                    VirtualInputManager:SendKeyEvent(true, "LeftControl", false, game)
                    task.wait(0.1)
                    VirtualInputManager:SendKeyEvent(false, "LeftControl", false, game)
                end)
            end
        end
    end)
end

Library:Notify("Fishing Exploit v8.0 Loaded!", 5)

-- Initial hook
task.wait(2)
HookGameFunctions()

-- Start auto fishing if enabled
if Config.AutoFish then
    task.wait(1)
    AdvancedAutoFishing()
end
