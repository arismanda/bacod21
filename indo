local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local VirtualInputManager = game:GetService("VirtualInputManager")

local LocalPlayer = Players.LocalPlayer
local FishingSystem = ReplicatedStorage:WaitForChild("FishingSystem", 10)

if not FishingSystem then
    for _, obj in pairs(ReplicatedStorage:GetDescendants()) do
        if obj.Name:lower():find("fish") and obj:IsA("ModuleScript") then
            FishingSystem = obj.Parent
            break
        end
    end
end

local Config = {
    AutoFish = true,
    InstantCatch = true,
    SilentCatch = true,
    MinRarity = "Common",
    MaxRarity = "Unknown",
    MinWeight = 1,
    MaxWeight = 999,
    WeightPrecision = 1,
    AutoSell = true,
    SellBelowRarity = "Rare",
    FishGiver = {
        Enabled = false,
        TargetPlayer = "",
        FishName = "El Maja",
        Rarity = "Unknown",
        Weight = 999
    },
    RandomWeight = {
        Enabled = true,
        Mode = "CustomRange",
        MinRange = 1,
        MaxRange = 999,
        Bias = 0.7,
        Fluctuation = 0.3
    },
    WebhookNotify = false,
    AntiAFK = true,
    BypassCooldown = false
}

local RarityOrder = {
    Common = 1,
    Uncommon = 2,
    Rare = 3,
    Epic = 4,
    Legendary = 5,
    Unknown = 6
}

local RarityColors = {
    Common = Color3.fromRGB(200, 200, 200),
    Uncommon = Color3.fromRGB(30, 255, 30),
    Rare = Color3.fromRGB(30, 100, 255),
    Epic = Color3.fromRGB(160, 30, 255),
    Legendary = Color3.fromRGB(255, 128, 0),
    Unknown = Color3.fromRGB(190, 0, 3)
}

local originalModule
local moduleHookActive = false

-- Fix: Perbaikan utama untuk fungsi GetRarityWithPity agar benar-benar mengoverride rarity
local function HookGameFunctions()
    if moduleHookActive then return end
    
    for _, module in pairs(getloadedmodules() or {}) do
        if module.Name:lower():find("fish") or module.Name:find("Fishing") then
            local success, moduleData = pcall(require, module)
            if success and type(moduleData) == "table" then
                originalModule = moduleData
                
                -- Debug: Cek jika module memiliki fungsi yang diperlukan
                print("[DEBUG] Module ditemukan:", module.Name)
                print("[DEBUG] Fungsi tersedia:")
                if moduleData.GetRarityWithPity then print("  - GetRarityWithPity ‚úì") end
                if moduleData.PickFishFromRarity then print("  - PickFishFromRarity ‚úì") end
                if moduleData.GenerateFishWeight then print("  - GenerateFishWeight ‚úì") end
                if moduleData.RollFish then print("  - RollFish ‚úì") end
                if moduleData.FishTable then print("  - FishTable (" .. #moduleData.FishTable .. " ikan) ‚úì") end
                
                -- FIX 1: Override GetRarityWithPity dengan benar
                if moduleData.GetRarityWithPity then
                    local originalGetRarity = moduleData.GetRarityWithPity
                    moduleData.GetRarityWithPity = function(pityTable, rodName, luckMultiplier)
                        if Config.InstantCatch then
                            local minOrder = RarityOrder[Config.MinRarity] or 1
                            local maxOrder = RarityOrder[Config.MaxRarity] or 6
                            
                            -- Debug info
                            print(string.format("[Rarity] Min: %s (%d), Max: %s (%d)", 
                                Config.MinRarity, minOrder, Config.MaxRarity, maxOrder))
                            
                            -- Generate rarity sesuai config
                            local targetOrder
                            if minOrder == maxOrder then
                                targetOrder = minOrder
                            else
                                targetOrder = math.random(minOrder, maxOrder)
                            end
                            
                            -- Cari rarity berdasarkan order
                            local selectedRarity = Config.MaxRarity
                            for rarity, order in pairs(RarityOrder) do
                                if order == targetOrder then
                                    selectedRarity = rarity
                                    break
                                end
                            end
                            
                            print("[Rarity] Selected:", selectedRarity, "Order:", targetOrder)
                            return selectedRarity
                        end
                        return originalGetRarity(pityTable, rodName, luckMultiplier)
                    end
                else
                    print("[WARN] GetRarityWithPity tidak ditemukan di module!")
                end
                
                -- FIX 2: Override PickFishFromRarity untuk memilih ikan berdasarkan rarity yang sudah dioverride
                if moduleData.PickFishFromRarity then
                    local originalPickFish = moduleData.PickFishFromRarity
                    moduleData.PickFishFromRarity = function(rarity)
                        if Config.InstantCatch then
                            local fishTable = moduleData.FishTable or {}
                            local eligibleFish = {}
                            
                            -- Filter ikan berdasarkan rarity
                            for _, fish in pairs(fishTable) do
                                if fish.rarity == rarity then
                                    table.insert(eligibleFish, fish)
                                end
                            end
                            
                            -- Jika tidak ada ikan dengan rarity tersebut, cari yang rarity lebih rendah
                            if #eligibleFish == 0 then
                                print("[WARN] Tidak ada ikan untuk rarity:", rarity, ", mencari Common...")
                                for _, fish in pairs(fishTable) do
                                    if fish.rarity == "Common" then
                                        table.insert(eligibleFish, fish)
                                    end
                                end
                            end
                            
                            if #eligibleFish > 0 then
                                print("[DEBUG] Found", #eligibleFish, "fish for rarity:", rarity)
                                
                                -- Pilih ikan berdasarkan probability
                                local totalProbability = 0
                                for _, fish in pairs(eligibleFish) do
                                    totalProbability = totalProbability + (fish.probability or 30)
                                end
                                
                                local random = math.random() * totalProbability
                                local cumulative = 0
                                
                                for _, fish in pairs(eligibleFish) do
                                    cumulative = cumulative + (fish.probability or 30)
                                    if random <= cumulative then
                                        print("[DEBUG] Selected fish:", fish.name, "Weight:", fish.minKg, "-", fish.maxKg)
                                        return fish
                                    end
                                end
                                
                                return eligibleFish[1]
                            else
                                print("[ERROR] Tidak ada ikan yang cocok!")
                                return originalPickFish(rarity)
                            end
                        end
                        return originalPickFish(rarity)
                    end
                end
                
                -- FIX 3: Override GenerateFishWeight untuk kontrol berat ikan
                if moduleData.GenerateFishWeight then
                    local originalGenWeight = moduleData.GenerateFishWeight
                    moduleData.GenerateFishWeight = function(fishData, rodLuck, maxWeight)
                        if Config.InstantCatch or Config.RandomWeight.Enabled then
                            local weight
                            
                            if Config.RandomWeight.Enabled then
                                local mode = Config.RandomWeight.Mode
                                
                                if mode == "CustomRange" then
                                    weight = math.random(Config.RandomWeight.MinRange * 10, Config.RandomWeight.MaxRange * 10) / 10
                                elseif mode == "Extreme" then
                                    local scale = RarityOrder[fishData.rarity] or 1
                                    weight = math.random(50 * scale, 500 * scale)
                                elseif mode == "Chaos" then
                                    weight = math.random(1, 999)
                                else
                                    local minW = math.max(Config.MinWeight, fishData.minKg or 1)
                                    local maxW = math.min(Config.MaxWeight, fishData.maxKg or 999, maxWeight or 999)
                                    weight = minW + math.random() * (maxW - minW)
                                end
                                
                                -- Apply bias untuk weight tinggi
                                if Config.RandomWeight.Bias > 0.5 then
                                    weight = weight * (1 + (Config.RandomWeight.Bias - 0.5))
                                end
                                
                                -- Apply fluctuation
                                if Config.RandomWeight.Fluctuation > 0 then
                                    local fluctuation = (math.random() * 2 - 1) * Config.RandomWeight.Fluctuation
                                    weight = weight * (1 + fluctuation)
                                end
                            else
                                local minWeight = math.max(Config.MinWeight, fishData.minKg or 1)
                                local maxWeightAllowed = math.min(Config.MaxWeight, fishData.maxKg or 999, maxWeight or 999)
                                weight = minWeight + math.random() * (maxWeightAllowed - minWeight)
                            end
                            
                            -- Apply precision
                            local precision = Config.WeightPrecision or 1
                            local multiplier = 10 ^ precision
                            weight = math.floor(weight * multiplier + 0.5) / multiplier
                            
                            -- Clamp to min/max
                            weight = math.max(Config.MinWeight, math.min(Config.MaxWeight, weight))
                            
                            print("[Weight] Generated:", weight, "kg")
                            return weight
                        end
                        return originalGenWeight(fishData, rodLuck, maxWeight)
                    end
                end
                
                -- FIX 4: Override RollFish untuk silent catch
                if moduleData.RollFish then
                    local originalRollFish = moduleData.RollFish
                    moduleData.RollFish = function(pityTable, rodName, luckMultiplier)
                        if Config.SilentCatch then
                            print("[Silent Catch] Generating fish...")
                            
                            -- Gunakan GetRarityWithPity yang sudah dioverride
                            local rarity = moduleData.GetRarityWithPity(pityTable or {}, rodName or "Basic Rod", luckMultiplier or 1)
                            
                            -- Dapatkan ikan berdasarkan rarity
                            local fish = moduleData.PickFishFromRarity(rarity)
                            if not fish then
                                print("[ERROR] Failed to pick fish for rarity:", rarity)
                                return originalRollFish(pityTable, rodName, luckMultiplier)
                            end
                            
                            -- Generate berat
                            local weight = moduleData.GenerateFishWeight(fish, luckMultiplier or 1, 999)
                            
                            -- Hitung nilai berdasarkan base price 1.2 dari module baru
                            local value = math.floor(weight * 1.2 * (RarityOrder[rarity] or 1) * 10 + 0.5)
                            
                            print("[Result] Fish:", fish.name, "Rarity:", rarity, "Weight:", weight, "kg", "Value:", value)
                            
                            return {
                                name = fish.name,
                                rarity = fish.rarity,
                                weight = weight,
                                value = value
                            }
                        end
                        return originalRollFish(pityTable, rodName, luckMultiplier)
                    end
                end
                
                moduleHookActive = true
                print("[SUCCESS] Module berhasil dihook!")
                return true
            end
        end
    end
    
    print("[ERROR] Tidak ada module fishing yang ditemukan!")
    return false
end

-- Fungsi untuk test rarity
local function TestRaritySystem()
    if not originalModule then
        print("[TEST] Hook module terlebih dahulu!")
        return
    end
    
    if not originalModule.GetRarityWithPity then
        print("[TEST] GetRarityWithPity tidak tersedia!")
        return
    end
    
    local pityTable = {
        Rare = 0,
        Epic = 0,
        Legendary = 0,
        Unknown = 0
    }
    
    print("\n=== RARITY TEST ===")
    print("Config: " .. Config.MinRarity .. " - " .. Config.MaxRarity)
    print("Testing 10 times...\n")
    
    local results = {}
    
    for i = 1, 10 do
        local rarity = originalModule.GetRarityWithPity(pityTable, "Basic Rod", 1)
        results[rarity] = (results[rarity] or 0) + 1
        print(string.format("Test %02d: %s", i, rarity))
    end
    
    print("\n=== RESULTS ===")
    for rarity, count in pairs(results) do
        print(string.format("%-12s: %d times", rarity, count))
    end
    
    -- Cek apakah semua rarity dalam range config
    local minOrder = RarityOrder[Config.MinRarity] or 1
    local maxOrder = RarityOrder[Config.MaxRarity] or 6
    
    local valid = true
    for rarity, _ in pairs(results) do
        local rarityOrder = RarityOrder[rarity] or 0
        if rarityOrder < minOrder or rarityOrder > maxOrder then
            print(string.format("\n‚ö†Ô∏è WARNING: %s (order %d) di luar range config (%d-%d)", 
                rarity, rarityOrder, minOrder, maxOrder))
            valid = false
        end
    end
    
    if valid then
        print("\n‚úÖ SUCCESS: Semua rarity dalam range config!")
    else
        print("\n‚ùå FAILED: Ada rarity di luar range config!")
    end
end

local function SilentCatchFish()
    if not Config.SilentCatch then return false end
    
    local catchRemote = FishingSystem:FindFirstChild("CatchFish") or 
                       FishingSystem:FindFirstChild("ReelIn") or
                       FishingSystem:FindFirstChild("CompleteFishing")
    
    if catchRemote then
        if not originalModule then
            HookGameFunctions()
        end
        
        if originalModule and originalModule.GetRarityWithPity then
            local pityTable = {
                Rare = 0,
                Epic = 0,
                Legendary = 0,
                Unknown = 0
            }
            
            local rarity = originalModule.GetRarityWithPity(pityTable, "Basic Rod", 1)
            
            -- Generate berat
            local weight
            if Config.RandomWeight.Enabled then
                local mode = Config.RandomWeight.Mode
                if mode == "CustomRange" then
                    weight = math.random(Config.RandomWeight.MinRange * 10, Config.RandomWeight.MaxRange * 10) / 10
                else
                    weight = math.random(Config.MinWeight * 10, Config.MaxWeight * 10) / 10
                end
            else
                weight = math.random(Config.MinWeight * 10, Config.MaxWeight * 10) / 10
            end
            
            -- Apply precision
            local precision = Config.WeightPrecision or 1
            local multiplier = 10 ^ precision
            weight = math.floor(weight * multiplier + 0.5) / multiplier
            
            -- Pilih ikan berdasarkan rarity
            local fishName = "El Maja"
            if originalModule.FishTable then
                for _, fish in pairs(originalModule.FishTable) do
                    if fish.rarity == rarity then
                        fishName = fish.name
                        break
                    end
                end
            end
            
            local fakeFishData = {
                Name = fishName,
                Rarity = rarity,
                Weight = weight,
                Value = math.floor(weight * 1.2 * 100 * (RarityOrder[rarity] or 1))
            }
            
            print("[Silent Catch] Attempting:", fakeFishData.Name, fakeFishData.Rarity, fakeFishData.Weight .. "kg")
            
            local success = pcall(function()
                if catchRemote:IsA("RemoteEvent") then
                    catchRemote:FireServer(fakeFishData)
                elseif catchRemote:IsA("RemoteFunction") then
                    catchRemote:InvokeServer(fakeFishData)
                end
            end)
            
            return success
        end
    end
    return false
end

-- Auto fishing system
local AutoFishThread
local CatchCount = 0

local function AdvancedAutoFishing()
    if AutoFishThread then return end
    
    AutoFishThread = task.spawn(function()
        while Config.AutoFish do
            if not moduleHookActive then
                HookGameFunctions()
            end
            
            local castRemote = FishingSystem:FindFirstChild("CastLine") or 
                              FishingSystem:FindFirstChild("StartFishing")
            
            if castRemote then
                pcall(function()
                    if castRemote:IsA("RemoteEvent") then
                        castRemote:FireServer()
                    elseif castRemote:IsA("RemoteFunction") then
                        castRemote:InvokeServer()
                    end
                end)
                
                local waitTime = Config.BypassCooldown and 0.1 or math.random(0.5, 2.0)
                task.wait(waitTime)
                
                if Config.SilentCatch then
                    SilentCatchFish()
                else
                    local catchRemote = FishingSystem:FindFirstChild("CatchFish")
                    if catchRemote then
                        pcall(function()
                            catchRemote:FireServer()
                        end)
                    end
                end
                
                CatchCount = CatchCount + 1
                
                if Config.AutoSell and CatchCount % 5 == 0 then
                    task.spawn(function()
                        local sellRemote = FishingSystem:FindFirstChild("SellFish")
                        if sellRemote then
                            for rarity, order in pairs(RarityOrder) do
                                local sellOrder = RarityOrder[Config.SellBelowRarity] or 3
                                if order < sellOrder then
                                    pcall(function()
                                        sellRemote:FireServer(rarity)
                                    end)
                                    task.wait(0.1)
                                end
                            end
                        end
                    end)
                end
            end
            
            local delay = math.random(100, 300) / 100
            task.wait(delay)
        end
    end)
end

-- Load UI Library
local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/xHeptc/Kavo-UI-Library/main/source.lua"))()
local Window = Library.CreateLib("Fishing Simulator v9.0", "DarkTheme")

-- Main Tab
local MainTab = Window:NewTab("Main")
local FishingSection = MainTab:NewSection("Fishing Features")

FishingSection:NewToggle("Auto Fish", "Automatically fishes", function(state)
    Config.AutoFish = state
    if state then
        AdvancedAutoFishing()
    else
        if AutoFishThread then
            task.cancel(AutoFishThread)
            AutoFishThread = nil
        end
    end
end)

FishingSection:NewToggle("Instant Catch", "Skip minigame (force rarity)", function(state)
    Config.InstantCatch = state
    HookGameFunctions()
end)

FishingSection:NewToggle("Silent Catch", "No animation", function(state)
    Config.SilentCatch = state
end)

-- Rarity Tab
local RarityTab = Window:NewTab("Rarity Control")
local MinRaritySection = RarityTab:NewSection("Minimum Rarity")

local MinRarityDropdown = MinRaritySection:NewDropdown("Min Rarity", "Lowest rarity", 
    {"Common", "Uncommon", "Rare", "Epic", "Legendary", "Unknown"}, 
    function(selected)
        Config.MinRarity = selected
        print("[Config] Min Rarity changed to:", selected)
    end)
MinRarityDropdown:SetOption("Common")

local MaxRaritySection = RarityTab:NewSection("Maximum Rarity")
local MaxRarityDropdown = MaxRaritySection:NewDropdown("Max Rarity", "Highest rarity", 
    {"Common", "Uncommon", "Rare", "Epic", "Legendary", "Unknown"}, 
    function(selected)
        Config.MaxRarity = selected
        print("[Config] Max Rarity changed to:", selected)
    end)
MaxRarityDropdown:SetOption("Unknown")

-- Test Tab
local TestTab = Window:NewTab("Testing")
local TestSection = TestTab:NewSection("Function Tests")

TestSection:NewButton("Hook Functions", "Hook fishing module", function()
    local success = HookGameFunctions()
    Library:Notify(success and "‚úÖ Module berhasil dihook!" or "‚ùå Gagal hook module", 3)
end)

TestSection:NewButton("Test Rarity System", "Test rarity override", function()
    TestRaritySystem()
    Library:Notify("Rarity test completed! Check console.", 3)
end)

TestSection:NewButton("Test Silent Catch", "Test catch function", function()
    local success = SilentCatchFish()
    Library:Notify(success and "‚úÖ Silent catch successful!" or "‚ùå Silent catch failed", 3)
end)

TestSection:NewButton("Force Unknown Rarity", "Get Unknown rarity fish", function()
    if originalModule and originalModule.GetRarityWithPity then
        local pityTable = {
            Rare = 0,
            Epic = 0,
            Legendary = 0,
            Unknown = 0
        }
        
        -- Force Unknown rarity
        local originalMin = Config.MinRarity
        local originalMax = Config.MaxRarity
        
        Config.MinRarity = "Unknown"
        Config.MaxRarity = "Unknown"
        
        local rarity = originalModule.GetRarityWithPity(pityTable, "Basic Rod", 1)
        
        -- Restore original config
        Config.MinRarity = originalMin
        Config.MaxRarity = originalMax
        
        Library:Notify("Forced rarity: " .. rarity, 3)
    else
        Library:Notify("Module not hooked!", 3)
    end
end)

-- Stats Tab
local StatsTab = Window:NewTab("Stats")
local LiveStats = StatsTab:NewSection("Statistics")

local TotalCatches = LiveStats:NewLabel("Total Catches: 0")
local CurrentRarity = LiveStats:NewLabel("Rarity Range: Common - Unknown")
local ModuleStatus = LiveStats:NewLabel("Module: Not Hooked")

task.spawn(function()
    while task.wait(1) do
        TotalCatches:UpdateLabel("Total Catches: " .. CatchCount)
        CurrentRarity:UpdateLabel("Rarity Range: " .. Config.MinRarity .. " - " .. Config.MaxRarity)
        ModuleStatus:UpdateLabel("Module: " .. (moduleHookActive and "‚úÖ Hooked" or "‚ùå Not Hooked"))
    end
end)

-- Utilities Tab
local UtilTab = Window:NewTab("Utilities")
local UtilitySection = UtilTab:NewSection("Tools")

UtilitySection:NewToggle("Anti-AFK", "Prevent AFK", function(state)
    Config.AntiAFK = state
end)

UtilitySection:NewButton("Debug Info", "Show debug information", function()
    if originalModule then
        local info = "=== DEBUG INFO ===\n"
        info = info .. "Module: " .. (moduleHookActive and "Hooked" or "Not Hooked") .. "\n"
        info = info .. "Rarity Range: " .. Config.MinRarity .. " - " .. Config.MaxRarity .. "\n"
        info = info .. "Instant Catch: " .. (Config.InstantCatch and "ON" or "OFF") .. "\n"
        info = info .. "Silent Catch: " .. (Config.SilentCatch and "ON" or "OFF") .. "\n"
        
        if originalModule.FishTable then
            info = info .. "Fish Count: " .. #originalModule.FishTable .. "\n"
            
            -- Count fish by rarity
            local rarityCount = {}
            for _, fish in pairs(originalModule.FishTable) do
                rarityCount[fish.rarity] = (rarityCount[fish.rarity] or 0) + 1
            end
            
            info = info .. "\nFish by Rarity:\n"
            for rarity, count in pairs(rarityCount) do
                info = info .. "  " .. rarity .. ": " .. count .. "\n"
            end
        end
        
        Library:Notify(info, 5)
    else
        Library:Notify("Module not hooked!", 3)
    end
end)

-- Anti-AFK
if Config.AntiAFK then
    task.spawn(function()
        while task.wait(60) do
            if Config.AntiAFK then
                pcall(function()
                    VirtualInputManager:SendKeyEvent(true, "LeftControl", false, game)
                    task.wait(0.1)
                    VirtualInputManager:SendKeyEvent(false, "LeftControl", false, game)
                end)
            end
        end
    end)
end

Library:Notify("Fishing Exploit v9.0 Loaded!", 5)

-- Initial setup
print("\n" .. string.rep("=", 50))
print("üé£ FISHING EXPLOIT v9.0")
print("Rarity System: Common -> Uncommon -> Rare -> Epic -> Legendary -> Unknown")
print("Base Price: 1.2 coins per kg")
print("Unknown Rarity: 0.02% probability (highest rarity)")
print(string.rep("=", 50) .. "\n")

-- Hook modules
task.wait(2)
HookGameFunctions()

-- Start auto fishing if enabled
if Config.AutoFish then
    task.wait(1)
    AdvancedAutoFishing()
end
