local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local VirtualInputManager = game:GetService("VirtualInputManager")

local LocalPlayer = Players.LocalPlayer
local FishingSystem = ReplicatedStorage:WaitForChild("FishingYahiko", 10)

if not FishingSystem then
    for _, obj in pairs(ReplicatedStorage:GetDescendants()) do
        if obj.Name:lower():find("fish") and obj:IsA("ModuleScript") then
            FishingSystem = obj.Parent
            break
        end
    end
end

local Config = {
    AutoFish = true,
    InstantCatch = true,
    SilentCatch = true,
    MinRarity = "Common",
    MaxRarity = "Secret",
    MinWeight = 1,
    MaxWeight = 999,
    WeightPrecision = 1,
    AutoSell = true,
    SellBelowRarity = "Rare",
    DebugMode = false,
    FishGiver = {
        Enabled = false,
        TargetPlayer = "",
        FishName = "Megalodon",
        Rarity = "Secret",
        Weight = 999
    },
    RandomWeight = {
        Enabled = true,
        Mode = "CustomRange",
        MinRange = 1,
        MaxRange = 999,
        Bias = 0.7,
        Fluctuation = 0.3
    },
    WebhookNotify = false,
    AntiAFK = true,
    BypassCooldown = false,
    ZoneFishing = "Default"
}

local RarityOrder = {
    Common = 1,
    Uncommon = 2,
    Rare = 3,
    Epic = 4,
    Legendary = 5,
    Mitos = 6,
    Secret = 7
}

local RarityColors = {
    Common = Color3.fromRGB(200, 200, 200),
    Uncommon = Color3.fromRGB(30, 255, 30),
    Rare = Color3.fromRGB(30, 100, 255),
    Epic = Color3.fromRGB(160, 30, 255),
    Legendary = Color3.fromRGB(255, 128, 0),
    Mitos = Color3.fromRGB(216, 0, 4),
    Secret = Color3.fromRGB(83, 255, 255)
}

local originalModule
local moduleHookActive = false
local testResults = {}

local function HookGameFunctions()
    if moduleHookActive then return end
    
    for _, module in pairs(getloadedmodules() or {}) do
        if module.Name:lower():find("fish") or module.Name:find("Fishing") or module.Name == "FishingYahiko" then
            local success, moduleData = pcall(require, module)
            if success and type(moduleData) == "table" then
                originalModule = moduleData
                
                -- Override GetRarityWithPity untuk kontrol rarity
                if moduleData.GetRarityWithPity then
                    local originalGetRarity = moduleData.GetRarityWithPity
                    moduleData.GetRarityWithPity = function(pityTable, rodName, luckMultiplier)
                        if Config.InstantCatch then
                            local minOrder = RarityOrder[Config.MinRarity] or 1
                            local maxOrder = RarityOrder[Config.MaxRarity] or 7
                            
                            -- Generate rarity sesuai config
                            local targetOrder
                            if minOrder == maxOrder then
                                targetOrder = minOrder
                            else
                                targetOrder = math.random(minOrder, maxOrder)
                            end
                            
                            -- Cari rarity berdasarkan order
                            local selectedRarity = Config.MaxRarity
                            for rarity, order in pairs(RarityOrder) do
                                if order == targetOrder then
                                    selectedRarity = rarity
                                    break
                                end
                            end
                            
                            return selectedRarity
                        end
                        return originalGetRarity(pityTable, rodName, luckMultiplier)
                    end
                end
                
                -- Override PickFishFromRarity untuk memastikan ikan sesuai rarity
                if moduleData.PickFishFromRarity then
                    local originalPickFish = moduleData.PickFishFromRarity
                    moduleData.PickFishFromRarity = function(rarity)
                        if Config.InstantCatch then
                            local fishTable = moduleData.FishTable or {}
                            local eligibleFish = {}
                            
                            -- Filter ikan berdasarkan rarity yang diinginkan
                            for _, fish in pairs(fishTable) do
                                if fish.rarity == rarity then
                                    table.insert(eligibleFish, fish)
                                end
                            end
                            
                            -- Jika tidak ada ikan dengan rarity tersebut, cari rarity yang lebih rendah
                            if #eligibleFish == 0 then
                                for _, fish in pairs(fishTable) do
                                    if fish.rarity == "Common" then
                                        table.insert(eligibleFish, fish)
                                    end
                                end
                            end
                            
                            if #eligibleFish > 0 then
                                -- Hitung total probability
                                local totalProbability = 0
                                for _, fish in pairs(eligibleFish) do
                                    totalProbability = totalProbability + (fish.probability or 30)
                                end
                                
                                -- Pilih ikan berdasarkan probability
                                local random = math.random() * totalProbability
                                local cumulative = 0
                                
                                for _, fish in pairs(eligibleFish) do
                                    cumulative = cumulative + (fish.probability or 30)
                                    if random <= cumulative then
                                        return fish
                                    end
                                end
                                
                                return eligibleFish[1]
                            end
                        end
                        return originalPickFish(rarity)
                    end
                end
                
                -- Override GenerateFishWeight untuk kontrol berat
                if moduleData.GenerateFishWeight then
                    local originalGenWeight = moduleData.GenerateFishWeight
                    moduleData.GenerateFishWeight = function(fishData, rodLuck, maxWeight)
                        if Config.InstantCatch or Config.RandomWeight.Enabled then
                            local weight
                            
                            if Config.RandomWeight.Enabled then
                                local mode = Config.RandomWeight.Mode
                                
                                if mode == "CustomRange" then
                                    weight = math.random(Config.RandomWeight.MinRange * 10, Config.RandomWeight.MaxRange * 10) / 10
                                elseif mode == "Extreme" then
                                    local scale = RarityOrder[fishData.rarity] or 1
                                    weight = math.random(50 * scale, 500 * scale)
                                elseif mode == "Chaos" then
                                    weight = math.random(1, 999)
                                else
                                    local minW = math.max(Config.MinWeight, fishData.minKg or 1)
                                    local maxW = math.min(Config.MaxWeight, fishData.maxKg or 999, maxWeight or 999)
                                    weight = minW + math.random() * (maxW - minW)
                                end
                                
                                -- Apply bias
                                if Config.RandomWeight.Bias > 0.5 then
                                    weight = weight * (1 + (Config.RandomWeight.Bias - 0.5))
                                end
                                
                                -- Apply fluctuation
                                if Config.RandomWeight.Fluctuation > 0 then
                                    local fluctuation = (math.random() * 2 - 1) * Config.RandomWeight.Fluctuation
                                    weight = weight * (1 + fluctuation)
                                end
                            else
                                local minWeight = math.max(Config.MinWeight, fishData.minKg or 1)
                                local maxWeightAllowed = math.min(Config.MaxWeight, fishData.maxKg or 999, maxWeight or 999)
                                weight = minWeight + math.random() * (maxWeightAllowed - minWeight)
                            end
                            
                            -- Apply precision
                            local precision = Config.WeightPrecision or 1
                            local multiplier = 10 ^ precision
                            weight = math.floor(weight * multiplier + 0.5) / multiplier
                            
                            -- Clamp to min/max
                            weight = math.max(Config.MinWeight, math.min(Config.MaxWeight, weight))
                            
                            return weight
                        end
                        return originalGenWeight(fishData, rodLuck, maxWeight)
                    end
                end
                
                -- Override RollFish untuk silent catch
                if moduleData.RollFish then
                    local originalRollFish = moduleData.RollFish
                    moduleData.RollFish = function(pityTable, rodName, luckMultiplier)
                        if Config.SilentCatch then
                            local rarity
                            
                            -- Pilih rarity sesuai config
                            local minOrder = RarityOrder[Config.MinRarity] or 1
                            local maxOrder = RarityOrder[Config.MaxRarity] or 7
                            local targetOrder = math.random(minOrder, maxOrder)
                            
                            for r, order in pairs(RarityOrder) do
                                if order == targetOrder then
                                    rarity = r
                                    break
                                end
                            end
                            rarity = rarity or Config.MaxRarity
                            
                            -- Dapatkan ikan berdasarkan rarity
                            local fish = moduleData.PickFishFromRarity(rarity)
                            if not fish then
                                return originalRollFish(pityTable, rodName, luckMultiplier)
                            end
                            
                            -- Generate berat
                            local weight = moduleData.GenerateFishWeight(fish, luckMultiplier or 1, 999)
                            
                            -- Hitung nilai
                            local value = math.floor(weight * 2 * (RarityOrder[rarity] or 1) * 10 + 0.5)
                            
                            return {
                                name = fish.name,
                                rarity = fish.rarity,
                                weight = weight,
                                value = value
                            }
                        end
                        return originalRollFish(pityTable, rodName, luckMultiplier)
                    end
                end
                
                -- Override RollFishWithZone
                if moduleData.RollFishWithZone then
                    local originalRollFishZone = moduleData.RollFishWithZone
                    moduleData.RollFishWithZone = function(pityTable, rodName, luckMultiplier, zone)
                        if Config.SilentCatch then
                            return moduleData.RollFish(pityTable, rodName, luckMultiplier)
                        end
                        return originalRollFishZone(pityTable, rodName, luckMultiplier, zone or Config.ZoneFishing)
                    end
                end
                
                moduleHookActive = true
                warn("[Fishing Exploit] Module successfully hooked!")
                break
            end
        end
    end
end

-- Fungsi untuk test rarity
local function PerformRarityTest()
    if not originalModule then
        HookGameFunctions()
        if not originalModule then
            return "Module not found!"
        end
    end
    
    testResults = {}
    local resultsText = ""
    
    -- Buat pity table
    local pityTable = {
        Rare = 0,
        Epic = 0,
        Legendary = 0,
        Mitos = 0,
        Secret = 0
    }
    
    -- Test 10 kali untuk melihat distribusi rarity
    for i = 1, 10 do
        local rarity
        if originalModule.GetRarityWithPity then
            rarity = originalModule.GetRarityWithPity(pityTable, "Basic Rod", 1)
        else
            rarity = "Test Failed"
        end
        
        -- Simpan hasil
        testResults[rarity] = (testResults[rarity] or 0) + 1
        
        resultsText = resultsText .. "Test " .. i .. ": " .. rarity .. "\n"
    end
    
    -- Buat summary
    local summary = "\n--- Rarity Distribution ---\n"
    for rarity, count in pairs(testResults) do
        summary = summary .. rarity .. ": " .. count .. " times (" .. (count / 10 * 100) .. "%)\n"
    end
    
    -- Cek apakah rarity sesuai dengan config
    local configRange = "Config Range: " .. Config.MinRarity .. " - " .. Config.MaxRarity
    summary = summary .. "\n" .. configRange
    
    -- Cek apakah ada rarity di luar range
    local valid = true
    for rarity, _ in pairs(testResults) do
        local rarityOrder = RarityOrder[rarity] or 0
        local minOrder = RarityOrder[Config.MinRarity] or 1
        local maxOrder = RarityOrder[Config.MaxRarity] or 7
        
        if rarityOrder < minOrder or rarityOrder > maxOrder then
            valid = false
            summary = summary .. "\n⚠️ WARNING: Found " .. rarity .. " outside configured range!"
        end
    end
    
    if valid then
        summary = summary .. "\n✅ All rarities are within configured range!"
    end
    
    return resultsText .. summary
end

local function TestSpecificRarity(targetRarity)
    if not originalModule then
        HookGameFunctions()
        if not originalModule then
            return "Module not found!"
        end
    end
    
    if not originalModule.PickFishFromRarity then
        return "PickFishFromRarity function not found!"
    end
    
    local fish = originalModule.PickFishFromRarity(targetRarity)
    if fish then
        return "✅ Found fish for " .. targetRarity .. ":\n" ..
               "Name: " .. (fish.name or "Unknown") .. "\n" ..
               "Rarity: " .. (fish.rarity or "Unknown") .. "\n" ..
               "Weight Range: " .. (fish.minKg or 0) .. "kg - " .. (fish.maxKg or 0) .. "kg\n" ..
               "Probability: " .. (fish.probability or 0)
    else
        return "❌ No fish found for rarity: " .. targetRarity
    end
end

local function TestFishWeight()
    if not originalModule then
        HookGameFunctions()
        if not originalModule then
            return "Module not found!"
        end
    end
    
    if not originalModule.GenerateFishWeight then
        return "GenerateFishWeight function not found!"
    end
    
    local testFish = {
        name = "Test Fish",
        rarity = "Common",
        minKg = 0.5,
        maxKg = 50
    }
    
    local results = "Weight Test Results:\n\n"
    
    -- Test 5 kali
    for i = 1, 5 do
        local weight = originalModule.GenerateFishWeight(testFish, 1, 999)
        results = results .. "Test " .. i .. ": " .. weight .. "kg\n"
        
        -- Cek apakah weight sesuai config
        if weight < Config.MinWeight then
            results = results .. "  ⚠️ Below Min Weight (" .. Config.MinWeight .. "kg)\n"
        elseif weight > Config.MaxWeight then
            results = results .. "  ⚠️ Above Max Weight (" .. Config.MaxWeight .. "kg)\n"
        else
            results = results .. "  ✅ Within configured range\n"
        end
    end
    
    return results
end

local function SilentCatchFish()
    if not Config.SilentCatch then return false end
    
    local catchRemote = FishingSystem:FindFirstChild("CatchFish") or 
                       FishingSystem:FindFirstChild("ReelIn") or
                       FishingSystem:FindFirstChild("CompleteFishing")
    
    if catchRemote then
        -- Pilih rarity
        local minOrder = RarityOrder[Config.MinRarity] or 1
        local maxOrder = RarityOrder[Config.MaxRarity] or 7
        local targetOrder = math.random(minOrder, maxOrder)
        local rarity = Config.MaxRarity
        
        for r, order in pairs(RarityOrder) do
            if order == targetOrder then
                rarity = r
                break
            end
        end
        
        -- Generate berat
        local weight
        if Config.RandomWeight.Enabled then
            local mode = Config.RandomWeight.Mode
            if mode == "CustomRange" then
                weight = math.random(Config.RandomWeight.MinRange * 10, Config.RandomWeight.MaxRange * 10) / 10
            else
                weight = math.random(Config.MinWeight * 10, Config.MaxWeight * 10) / 10
            end
        else
            weight = math.random(Config.MinWeight * 10, Config.MaxWeight * 10) / 10
        end
        
        -- Apply precision
        local precision = Config.WeightPrecision or 1
        local multiplier = 10 ^ precision
        weight = math.floor(weight * multiplier + 0.5) / multiplier
        
        local fakeFishData = {
            Name = "Megalodon",
            Rarity = rarity,
            Weight = weight,
            Value = math.floor(weight * 100 * (RarityOrder[rarity] or 1))
        }
        
        local success = pcall(function()
            if catchRemote:IsA("RemoteEvent") then
                catchRemote:FireServer(fakeFishData)
            elseif catchRemote:IsA("RemoteFunction") then
                catchRemote:InvokeServer(fakeFishData)
            end
        end)
        
        return success
    end
    return false
end

local function GiveFishToPlayer(targetName, fishName, rarity, weight)
    if not Config.FishGiver.Enabled or targetName == "" then return false end
    
    local targetPlayer = nil
    for _, player in pairs(Players:GetPlayers()) do
        if player.Name:lower():find(targetName:lower()) or player.DisplayName:lower():find(targetName:lower()) then
            targetPlayer = player
            break
        end
    end
    
    if not targetPlayer then return false end
    
    local giveRemote = FishingSystem:FindFirstChild("GiveFish") or 
                      FishingSystem:FindFirstChild("TradeFish") or
                      FishingSystem:FindFirstChild("TransferFish")
    
    if giveRemote then
        local fishData = {
            Player = targetPlayer,
            FishName = fishName or Config.FishGiver.FishName,
            Rarity = rarity or Config.FishGiver.Rarity,
            Weight = weight or Config.FishGiver.Weight,
            Value = (weight or 999) * 100 * (RarityOrder[rarity or Config.FishGiver.Rarity] or 1)
        }
        
        local success = pcall(function()
            if giveRemote:IsA("RemoteEvent") then
                giveRemote:FireServer(fishData)
            elseif giveRemote:IsA("RemoteFunction") then
                giveRemote:InvokeServer(fishData)
            end
        end)
        
        return success
    end
    
    return false
end

local AutoFishThread
local CatchCount = 0

local function AdvancedAutoFishing()
    if AutoFishThread then return end
    
    AutoFishThread = task.spawn(function()
        while Config.AutoFish do
            HookGameFunctions()
            
            local castRemote = FishingSystem:FindFirstChild("CastLine") or 
                              FishingSystem:FindFirstChild("StartFishing")
            
            if castRemote then
                -- Cast line
                pcall(function()
                    if castRemote:IsA("RemoteEvent") then
                        castRemote:FireServer()
                    elseif castRemote:IsA("RemoteFunction") then
                        castRemote:InvokeServer()
                    end
                end)
                
                -- Tunggu sebentar sebelum catch
                local waitTime = Config.BypassCooldown and 0.1 or math.random(0.5, 2.0)
                task.wait(waitTime)
                
                -- Catch fish
                if Config.SilentCatch then
                    SilentCatchFish()
                else
                    local catchRemote = FishingSystem:FindFirstChild("CatchFish")
                    if catchRemote then
                        pcall(function()
                            catchRemote:FireServer()
                        end)
                    end
                end
                
                CatchCount = CatchCount + 1
                
                -- Auto sell
                if Config.AutoSell and CatchCount % 5 == 0 then
                    task.spawn(function()
                        local sellRemote = FishingSystem:FindFirstChild("SellFish")
                        if sellRemote then
                            for rarity, order in pairs(RarityOrder) do
                                local sellOrder = RarityOrder[Config.SellBelowRarity] or 3
                                if order < sellOrder then
                                    pcall(function()
                                        sellRemote:FireServer(rarity)
                                    end)
                                    task.wait(0.1)
                                end
                            end
                        end
                    end)
                end
            end
            
            -- Delay antara fishing
            local delay = math.random(100, 300) / 100
            task.wait(delay)
        end
    end)
end

-- Load UI Library
local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/xHeptc/Kavo-UI-Library/main/source.lua"))()
local Window = Library.CreateLib("Fishing Yahiko v6.0", "DarkTheme")

-- Main Tab
local MainTab = Window:NewTab("Main")
local FishingSection = MainTab:NewSection("Fishing Features")

FishingSection:NewToggle("Auto Fish", "Automatically fishes", function(state)
    Config.AutoFish = state
    if state then
        AdvancedAutoFishing()
    else
        if AutoFishThread then
            task.cancel(AutoFishThread)
            AutoFishThread = nil
        end
    end
end)

FishingSection:NewToggle("Instant Catch", "Skip minigame", function(state)
    Config.InstantCatch = state
    HookGameFunctions()
end)

FishingSection:NewToggle("Silent Catch", "No animation", function(state)
    Config.SilentCatch = state
end)

FishingSection:NewToggle("Debug Mode", "Show debug messages", function(state)
    Config.DebugMode = state
end)

-- Rarity Tab
local RarityTab = Window:NewTab("Rarity Control")
local MinRaritySection = RarityTab:NewSection("Minimum Rarity")

local MinRarityDropdown = MinRaritySection:NewDropdown("Min Rarity", "Lowest rarity", 
    {"Common", "Uncommon", "Rare", "Epic", "Legendary", "Mitos", "Secret"}, 
    function(selected)
        Config.MinRarity = selected
    end)
MinRarityDropdown:SetOption("Common")

local MaxRaritySection = RarityTab:NewSection("Maximum Rarity")
local MaxRarityDropdown = MaxRaritySection:NewDropdown("Max Rarity", "Highest rarity", 
    {"Common", "Uncommon", "Rare", "Epic", "Legendary", "Mitos", "Secret"}, 
    function(selected)
        Config.MaxRarity = selected
    end)
MaxRarityDropdown:SetOption("Secret")

-- Weight Tab
local WeightTab = Window:NewTab("Weight Control")
local WeightRangeSection = WeightTab:NewSection("Weight Range")

local MinWeightSlider = WeightRangeSection:NewSlider("Min Weight", "Minimum weight", 1000, 0.1, function(value)
    Config.MinWeight = value
end)
MinWeightSlider:SetValue(1)

local MaxWeightSlider = WeightRangeSection:NewSlider("Max Weight", "Maximum weight", 1000, 0.1, function(value)
    Config.MaxWeight = value
end)
MaxWeightSlider:SetValue(999)

local RandomWeightSection = WeightTab:NewSection("Random Weight")

RandomWeightSection:NewToggle("Enable Random Weight", "Randomize weights", function(state)
    Config.RandomWeight.Enabled = state
end)

local WeightModeDropdown = RandomWeightSection:NewDropdown("Weight Mode", "Weight generation mode", 
    {"Original", "CustomRange", "Extreme", "Chaos"}, 
    function(selected)
        Config.RandomWeight.Mode = selected
    end)
WeightModeDropdown:SetOption("CustomRange")

local CustomMinSlider = RandomWeightSection:NewSlider("Custom Min", "Minimum for custom mode", 
    1000, 1, 100, function(value)
    Config.RandomWeight.MinRange = value
end)
CustomMinSlider:SetValue(1)

local CustomMaxSlider = RandomWeightSection:NewSlider("Custom Max", "Maximum for custom mode", 
    1000, 100, 999, function(value)
    Config.RandomWeight.MaxRange = value
end)
CustomMaxSlider:SetValue(999)

local BiasSlider = RandomWeightSection:NewSlider("Weight Bias", "Bias to high weights", 
    100, 0, 100, function(value)
    Config.RandomWeight.Bias = value / 100
end)
BiasSlider:SetValue(70)

local FluctuationSlider = RandomWeightSection:NewSlider("Fluctuation", "Random variation", 
    100, 0, 100, function(value)
    Config.RandomWeight.Fluctuation = value / 100
end)
FluctuationSlider:SetValue(30)

local PrecisionSection = WeightTab:NewSection("Precision")
local PrecisionSlider = PrecisionSection:NewSlider("Decimal Places", "Weight precision", 3, 0, function(value)
    Config.WeightPrecision = value
end)
PrecisionSlider:SetValue(1)

-- Test Tab
local TestTab = Window:NewTab("Testing")
local TestSection = TestTab:NewSection("Rarity & Function Tests")

TestSection:NewButton("Hook Functions", "Hook fishing module", function()
    HookGameFunctions()
    Library:Notify(moduleHookActive and "✅ Successfully hooked!" or "❌ Failed to hook", 3)
end)

TestSection:NewButton("Rarity Test (10x)", "Test rarity distribution", function()
    local result = PerformRarityTest()
    Library:Notify("Rarity Test Results", 5)
    
    -- Buat window untuk menampilkan hasil lengkap
    local TextWindow = Instance.new("ScreenGui")
    local TextFrame = Instance.new("Frame")
    local TextBox = Instance.new("TextBox")
    local CloseButton = Instance.new("TextButton")
    
    TextWindow.Name = "TestResultsWindow"
    TextWindow.Parent = game.CoreGui
    
    TextFrame.Name = "MainFrame"
    TextFrame.Parent = TextWindow
    TextFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    TextFrame.BorderSizePixel = 2
    TextFrame.BorderColor3 = Color3.fromRGB(0, 170, 255)
    TextFrame.Position = UDim2.new(0.3, 0, 0.3, 0)
    TextFrame.Size = UDim2.new(0.4, 0, 0.4, 0)
    
    TextBox.Name = "ResultsText"
    TextBox.Parent = TextFrame
    TextBox.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    TextBox.BorderSizePixel = 0
    TextBox.Position = UDim2.new(0.05, 0, 0.1, 0)
    TextBox.Size = UDim2.new(0.9, 0, 0.8, 0)
    TextBox.Text = result
    TextBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    TextBox.TextSize = 14
    TextBox.TextWrapped = true
    TextBox.TextXAlignment = Enum.TextXAlignment.Left
    TextBox.TextYAlignment = Enum.TextYAlignment.Top
    TextBox.MultiLine = true
    TextBox.ClearTextOnFocus = false
    
    CloseButton.Name = "CloseButton"
    CloseButton.Parent = TextFrame
    CloseButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
    CloseButton.BorderSizePixel = 0
    CloseButton.Position = UDim2.new(0.8, 0, 0.92, 0)
    CloseButton.Size = UDim2.new(0.15, 0, 0.05, 0)
    CloseButton.Font = Enum.Font.SourceSans
    CloseButton.Text = "Close"
    CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    CloseButton.TextSize = 14
    
    CloseButton.MouseButton1Click:Connect(function()
        TextWindow:Destroy()
    end)
end)

TestSection:NewButton("Test Specific Rarity", "Test fish for specific rarity", function()
    local rarityOptions = {"Common", "Uncommon", "Rare", "Epic", "Legendary", "Mitos", "Secret"}
    
    -- Buat dropdown sederhana
    local DropdownWindow = Instance.new("ScreenGui")
    local DropdownFrame = Instance.new("Frame")
    local DropdownText = Instance.new("TextLabel")
    local DropdownBox = Instance.new("TextBox")
    local TestButton = Instance.new("TextButton")
    local CloseButton = Instance.new("TextButton")
    
    DropdownWindow.Name = "RarityTestWindow"
    DropdownWindow.Parent = game.CoreGui
    
    DropdownFrame.Name = "MainFrame"
    DropdownFrame.Parent = DropdownWindow
    DropdownFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    DropdownFrame.BorderSizePixel = 2
    DropdownFrame.BorderColor3 = Color3.fromRGB(0, 170, 255)
    DropdownFrame.Position = UDim2.new(0.4, 0, 0.4, 0)
    DropdownFrame.Size = UDim2.new(0.2, 0, 0.2, 0)
    
    DropdownText.Name = "Label"
    DropdownText.Parent = DropdownFrame
    DropdownText.BackgroundTransparency = 1
    DropdownText.Position = UDim2.new(0.1, 0, 0.1, 0)
    DropdownText.Size = UDim2.new(0.8, 0, 0.2, 0)
    DropdownText.Text = "Select Rarity to Test:"
    DropdownText.TextColor3 = Color3.fromRGB(255, 255, 255)
    DropdownText.TextSize = 14
    
    DropdownBox.Name = "RarityInput"
    DropdownBox.Parent = DropdownFrame
    DropdownBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    DropdownBox.BorderSizePixel = 0
    DropdownBox.Position = UDim2.new(0.1, 0, 0.4, 0)
    DropdownBox.Size = UDim2.new(0.8, 0, 0.15, 0)
    DropdownBox.Text = "Common"
    DropdownBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    DropdownBox.TextSize = 14
    DropdownBox.PlaceholderText = "Enter rarity..."
    
    TestButton.Name = "TestBtn"
    TestButton.Parent = DropdownFrame
    TestButton.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
    TestButton.BorderSizePixel = 0
    TestButton.Position = UDim2.new(0.1, 0, 0.65, 0)
    TestButton.Size = UDim2.new(0.35, 0, 0.15, 0)
    TestButton.Font = Enum.Font.SourceSans
    TestButton.Text = "Test"
    TestButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    TestButton.TextSize = 14
    
    CloseButton.Name = "CloseBtn"
    CloseButton.Parent = DropdownFrame
    CloseButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
    CloseButton.BorderSizePixel = 0
    CloseButton.Position = UDim2.new(0.55, 0, 0.65, 0)
    CloseButton.Size = UDim2.new(0.35, 0, 0.15, 0)
    CloseButton.Font = Enum.Font.SourceSans
    CloseButton.Text = "Close"
    CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    CloseButton.TextSize = 14
    
    TestButton.MouseButton1Click:Connect(function()
        local rarity = DropdownBox.Text
        local result = TestSpecificRarity(rarity)
        
        -- Tampilkan hasil
        local ResultWindow = Instance.new("ScreenGui")
        local ResultFrame = Instance.new("Frame")
        local ResultText = Instance.new("TextBox")
        local CloseBtn = Instance.new("TextButton")
        
        ResultWindow.Name = "TestResultWindow"
        ResultWindow.Parent = game.CoreGui
        
        ResultFrame.Name = "ResultFrame"
        ResultFrame.Parent = ResultWindow
        ResultFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
        ResultFrame.BorderSizePixel = 2
        ResultFrame.BorderColor3 = Color3.fromRGB(0, 170, 255)
        ResultFrame.Position = UDim2.new(0.3, 0, 0.3, 0)
        ResultFrame.Size = UDim2.new(0.4, 0, 0.4, 0)
        
        ResultText.Name = "ResultTextBox"
        ResultText.Parent = ResultFrame
        ResultText.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
        ResultText.BorderSizePixel = 0
        ResultText.Position = UDim2.new(0.05, 0, 0.1, 0)
        ResultText.Size = UDim2.new(0.9, 0, 0.8, 0)
        ResultText.Text = result
        ResultText.TextColor3 = Color3.fromRGB(255, 255, 255)
        ResultText.TextSize = 14
        ResultText.TextWrapped = true
        ResultText.TextXAlignment = Enum.TextXAlignment.Left
        ResultText.TextYAlignment = Enum.TextYAlignment.Top
        ResultText.MultiLine = true
        ResultText.ClearTextOnFocus = false
        
        CloseBtn.Name = "CloseResultBtn"
        CloseBtn.Parent = ResultFrame
        CloseBtn.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
        CloseBtn.BorderSizePixel = 0
        CloseBtn.Position = UDim2.new(0.8, 0, 0.92, 0)
        CloseBtn.Size = UDim2.new(0.15, 0, 0.05, 0)
        CloseBtn.Font = Enum.Font.SourceSans
        CloseBtn.Text = "Close"
        CloseBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        CloseBtn.TextSize = 14
        
        CloseBtn.MouseButton1Click:Connect(function()
            ResultWindow:Destroy()
        end)
        
        DropdownWindow:Destroy()
    end)
    
    CloseButton.MouseButton1Click:Connect(function()
        DropdownWindow:Destroy()
    end)
end)

TestSection:NewButton("Test Fish Weight", "Test weight generation", function()
    local result = TestFishWeight()
    Library:Notify("Weight Test Results", 5)
    
    -- Buat window untuk menampilkan hasil
    local TextWindow = Instance.new("ScreenGui")
    local TextFrame = Instance.new("Frame")
    local TextBox = Instance.new("TextBox")
    local CloseButton = Instance.new("TextButton")
    
    TextWindow.Name = "WeightTestWindow"
    TextWindow.Parent = game.CoreGui
    
    TextFrame.Name = "MainFrame"
    TextFrame.Parent = TextWindow
    TextFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    TextFrame.BorderSizePixel = 2
    TextFrame.BorderColor3 = Color3.fromRGB(0, 170, 255)
    TextFrame.Position = UDim2.new(0.3, 0, 0.3, 0)
    TextFrame.Size = UDim2.new(0.4, 0, 0.4, 0)
    
    TextBox.Name = "ResultsText"
    TextBox.Parent = TextFrame
    TextBox.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    TextBox.BorderSizePixel = 0
    TextBox.Position = UDim2.new(0.05, 0, 0.1, 0)
    TextBox.Size = UDim2.new(0.9, 0, 0.8, 0)
    TextBox.Text = result
    TextBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    TextBox.TextSize = 14
    TextBox.TextWrapped = true
    TextBox.TextXAlignment = Enum.TextXAlignment.Left
    TextBox.TextYAlignment = Enum.TextYAlignment.Top
    TextBox.MultiLine = true
    TextBox.ClearTextOnFocus = false
    
    CloseButton.Name = "CloseButton"
    CloseButton.Parent = TextFrame
    CloseButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
    CloseButton.BorderSizePixel = 0
    CloseButton.Position = UDim2.new(0.8, 0, 0.92, 0)
    CloseButton.Size = UDim2.new(0.15, 0, 0.05, 0)
    CloseButton.Font = Enum.Font.SourceSans
    CloseButton.Text = "Close"
    CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    CloseButton.TextSize = 14
    
    CloseButton.MouseButton1Click:Connect(function()
        TextWindow:Destroy()
    end)
end)

TestSection:NewButton("Test Silent Catch", "Test catch function", function()
    local success = SilentCatchFish()
    Library:Notify(success and "✅ Silent catch successful!" or "❌ Silent catch failed", 3)
end)

TestSection:NewButton("Check Module Status", "Check if module is hooked", function()
    if originalModule then
        local status = "✅ Module is hooked!\n"
        status = status .. "Functions available:\n"
        
        if originalModule.GetRarityWithPity then status = status .. "- GetRarityWithPity ✓\n" end
        if originalModule.PickFishFromRarity then status = status .. "- PickFishFromRarity ✓\n" end
        if originalModule.GenerateFishWeight then status = status .. "- GenerateFishWeight ✓\n" end
        if originalModule.RollFish then status = status .. "- RollFish ✓\n" end
        if originalModule.RollFishWithZone then status = status .. "- RollFishWithZone ✓\n" end
        
        Library:Notify(status, 5)
    else
        Library:Notify("❌ Module not hooked!", 3)
    end
end)

-- Give Tab
local GiveTab = Window:NewTab("Fish Giver")
local GiveSection = GiveTab:NewSection("Give Fish")

GiveSection:NewToggle("Enable FishGiver", "Allow giving", function(state)
    Config.FishGiver.Enabled = state
end)

local PlayerTextBox = GiveSection:NewTextBox("Target Player", "Player name", function(text)
    Config.FishGiver.TargetPlayer = text
end)

local FishDropdown = GiveSection:NewDropdown("Fish Type", "Select fish", 
    {"Megalodon", "Ancient Whale", "Celestial Dragon", "Plasma Shark", "Pink Dolphin", "Kraken", "Leviathan", "Sotong", "King Crab"}, 
    function(selected)
        Config.FishGiver.FishName = selected
    end)
FishDropdown:SetOption("Megalodon")

local GiveRarityDropdown = GiveSection:NewDropdown("Give Rarity", "Rarity", 
    {"Common", "Uncommon", "Rare", "Epic", "Legendary", "Mitos", "Secret"}, 
    function(selected)
        Config.FishGiver.Rarity = selected
    end)
GiveRarityDropdown:SetOption("Secret")

local GiveWeightSlider = GiveSection:NewSlider("Give Weight", "Weight", 1000, 1, function(value)
    Config.FishGiver.Weight = value
end)
GiveWeightSlider:SetValue(999)

GiveSection:NewButton("Give Fish Now", "Execute give", function()
    local target = Config.FishGiver.TargetPlayer
    if target and target ~= "" then
        GiveFishToPlayer(target, Config.FishGiver.FishName, Config.FishGiver.Rarity, Config.FishGiver.Weight)
        Library:Notify("Fish give attempted", 3)
    else
        Library:Notify("Enter player name", 5)
    end
end)

-- Sell Tab
local SellTab = Window:NewTab("Auto Sell")
local SellSettings = SellTab:NewSection("Sell Configuration")

SellSettings:NewToggle("Auto Sell", "Automatically sell", function(state)
    Config.AutoSell = state
end)

local SellBelowDropdown = SellSettings:NewDropdown("Sell Below", "Sell below rarity", 
    {"Common", "Uncommon", "Rare", "Epic", "Legendary", "Mitos", "Secret"}, 
    function(selected)
        Config.SellBelowRarity = selected
    end)
SellBelowDropdown:SetOption("Rare")

SellSettings:NewButton("Sell All Now", "Sell all", function()
    local sellRemote = FishingSystem:FindFirstChild("SellFish") or 
                      FishingSystem:FindFirstChild("SellAllFish")
    
    if sellRemote then
        for rarity, order in pairs(RarityOrder) do
            local sellOrder = RarityOrder[Config.SellBelowRarity] or 3
            if order < sellOrder then
                pcall(function()
                    sellRemote:FireServer(rarity)
                    task.wait(0.1)
                end)
            end
        end
        Library:Notify("Sell completed", 3)
    end
end)

-- Stats Tab
local StatsTab = Window:NewTab("Stats")
local LiveStats = StatsTab:NewSection("Statistics")

local TotalCatches = LiveStats:NewLabel("Total Catches: 0")
local CurrentRarity = LiveStats:NewLabel("Rarity Range: Common - Secret")
local CurrentWeight = LiveStats:NewLabel("Weight Range: 1kg - 999kg")
local ModuleStatus = LiveStats:NewLabel("Module: Not Hooked")

task.spawn(function()
    while task.wait(1) do
        TotalCatches:UpdateLabel("Total Catches: " .. CatchCount)
        CurrentRarity:UpdateLabel("Rarity Range: " .. Config.MinRarity .. " - " .. Config.MaxRarity)
        CurrentWeight:UpdateLabel("Weight Range: " .. Config.MinWeight .. "kg - " .. Config.MaxWeight .. "kg")
        ModuleStatus:UpdateLabel("Module: " .. (moduleHookActive and "✅ Hooked" or "❌ Not Hooked"))
    end
end)

-- Utilities Tab
local UtilTab = Window:NewTab("Utilities")
local UtilitySection = UtilTab:NewSection("Tools")

UtilitySection:NewToggle("Bypass Cooldown", "Remove cooldown", function(state)
    Config.BypassCooldown = state
end)

UtilitySection:NewToggle("Anti-AFK", "Prevent AFK", function(state)
    Config.AntiAFK = state
end)

local ZoneDropdown = UtilitySection:NewDropdown("Fishing Zone", "Select fishing zone", 
    {"Default", "Ocean", "River", "Lake", "DeepSea"}, 
    function(selected)
        Config.ZoneFishing = selected
    end)
ZoneDropdown:SetOption("Default")

-- Anti-AFK
if Config.AntiAFK then
    task.spawn(function()
        while task.wait(60) do
            if Config.AntiAFK then
                pcall(function()
                    VirtualInputManager:SendKeyEvent(true, "LeftControl", false, game)
                    task.wait(0.1)
                    VirtualInputManager:SendKeyEvent(false, "LeftControl", false, game)
                end)
            end
        end
    end)
end

Library:Notify("Fishing Yahiko Exploit v6.0 Loaded!", 5)

-- Initial hook
task.wait(2)
HookGameFunctions()
